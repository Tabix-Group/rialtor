generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(uuid())
  email               String               @unique
  password            String
  name                String
  phone               String?
  office              String?
  avatar              String?
  isActive            Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  articles            Article[]
  calculatorHistory   CalculatorHistory[]
  calendarToken       CalendarToken?
  chatSessions        ChatSession[]
  comments            Comment[]
  documentFavorites   DocumentFavorite[]
  documentRequests    DocumentRequest[]
  documentTemplates   DocumentTemplate[]
  fileUploads         FileUpload[]
  financeTransactions FinanceTransaction[]
  newsletters         Newsletter[]
  propertyPlaques     PropertyPlaque[]
  prospects           Prospect[]
  roleAssignments     RoleAssignment[]
  salesFunnel         SalesFunnel?

  @@map("users")
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  assignments RoleAssignment[]
  permissions Permission[]     @relation("PermissionToRole")

  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  roles       Role[]   @relation("PermissionToRole")

  @@map("permissions")
}

model RoleAssignment {
  id         String   @id @default(uuid())
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  role       Role     @relation(fields: [roleId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, roleId])
  @@map("role_assignments")
}

model Category {
  id          String     @id @default(uuid())
  name        String     @unique
  description String?
  slug        String     @unique
  color       String     @default("#3B82F6")
  icon        String?
  parentId    String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  articles    Article[]
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  news        News[]

  @@map("categories")
}

model Article {
  id          String       @id @default(uuid())
  title       String
  slug        String       @unique
  content     String
  excerpt     String?
  status      String       @default("DRAFT")
  views       Int          @default(0)
  featured    Boolean      @default(false)
  tags        String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  authorId    String
  categoryId  String
  author      User         @relation(fields: [authorId], references: [id])
  category    Category     @relation(fields: [categoryId], references: [id])
  attachments Attachment[]
  comments    Comment[]

  @@map("articles")
}

model Comment {
  id         String   @id @default(uuid())
  content    String
  isApproved Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  authorId   String
  articleId  String
  article    Article  @relation(fields: [articleId], references: [id])
  author     User     @relation(fields: [authorId], references: [id])

  @@map("comments")
}

model Attachment {
  id           String   @id @default(uuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  path         String
  createdAt    DateTime @default(now())
  articleId    String
  article      Article  @relation(fields: [articleId], references: [id])

  @@map("attachments")
}

model ChatSession {
  id        String        @id @default(uuid())
  title     String?
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  userId    String
  messages  ChatMessage[]
  user      User          @relation(fields: [userId], references: [id])

  @@map("chat_sessions")
}

model ChatMessage {
  id        String      @id @default(uuid())
  content   String
  role      String
  metadata  String?
  createdAt DateTime    @default(now())
  sessionId String
  session   ChatSession @relation(fields: [sessionId], references: [id])

  @@map("chat_messages")
}

model DocumentTemplate {
  id           String            @id @default(uuid())
  name         String
  description  String?
  category     String
  template     String
  fields       String
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  cloudinaryId String?
  content      String?
  title        String?
  url          String?
  userId       String
  requests     DocumentRequest[]
  user         User              @relation(fields: [userId], references: [id])

  @@map("document_templates")
}

model DocumentRequest {
  id         String           @id @default(uuid())
  status     String           @default("PENDING")
  data       String
  result     String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  userId     String
  templateId String
  template   DocumentTemplate @relation(fields: [templateId], references: [id])
  user       User             @relation(fields: [userId], references: [id])

  @@map("document_requests")
}

model CalculatorConfig {
  id        String   @id @default(uuid())
  type      String   @unique
  name      String
  rates     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("calculator_configs")
}

model CalculatorHistory {
  id        String   @id @default(uuid())
  type      String
  inputs    String
  result    String
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  @@map("calculator_history")
}

model SystemConfig {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  type        String   @default("STRING")
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_config")
}

model PropertyPlaque {
  id              String   @id @default(uuid())
  title           String
  description     String?
  propertyData    String
  originalImages  String
  generatedImages String
  status          String   @default("PROCESSING")
  aiPrompt        String?
  aiResponse      String?
  metadata        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  userId          String
  modelType       String   @default("standard") // "standard", "premium", "vip"
  user            User     @relation(fields: [userId], references: [id])

  @@map("property_plaques")
}

model BankRate {
  id           String   @id @default(uuid())
  bankName     String   @unique
  interestRate Float
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  termMonths   Int?

  @@map("bank_rates")
}

model News {
  id          String    @id @default(uuid())
  title       String
  synopsis    String
  source      String
  externalUrl String
  publishedAt DateTime  @default(now())
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])

  @@map("news")
}

model FileUpload {
  id            String   @id @default(uuid())
  filename      String
  originalName  String
  mimeType      String
  size          Int
  cloudinaryUrl String
  cloudinaryId  String
  folder        String   @default("Contenido")
  subfolder     String?
  uploadedBy    String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [uploadedBy], references: [id])

  @@map("file_uploads")
}

model DocumentFavorite {
  id           String   @id @default(uuid())
  documentId   String
  documentName String
  folder       String
  createdAt    DateTime @default(now())
  userId       String
  user         User     @relation(fields: [userId], references: [id])

  @@unique([userId, documentId])
  @@map("document_favorites")
}

model FinanceTransaction {
  id          String   @id @default(uuid())
  tipo        String   @default("Laboral") // "Personal" o "Laboral"
  type        String
  concept     String
  description String?
  amount      Float
  currency    String
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String
  user        User     @relation(fields: [userId], references: [id])

  @@map("finance_transactions")
}

// Prospects model: personal prospecting records for each user
enum ProspectStatus {
  PROSPECTOS
  TASACIONES
  CAPTACIONES
  RESERVAS
  CIERRES
}

model Prospect {
  id                  String         @id @default(uuid())
  title               String
  note                String?
  estimatedValue      Float?
  estimatedCommission Float? // Suggested commission estimate
  clientsProspected   Int?           @default(0)
  probability         Int? // 0-100
  status              ProspectStatus @default(PROSPECTOS)
  closedValue         Float?
  closeDate           DateTime?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  userId              String
  user                User           @relation(fields: [userId], references: [id])

  @@map("prospects")
}

model CalendarToken {
  id           String    @id @default(uuid())
  userId       String    @unique
  accessToken  String
  refreshToken String?
  expiryDate   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id])

  @@map("calendar_tokens")
}

model EconomicIndex {
  id          String   @id @default(uuid())
  indicator   String // 'ipc', 'cacGeneral', 'cacMateriales', 'cacManoObra', 'icc', 'is'
  value       Float
  variation   Float?
  date        DateTime
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([indicator, date])
  @@map("economic_indices")
}

model Newsletter {
  id         String   @id @default(uuid())
  title      String
  content    String // HTML content
  images     String // JSON array of image URLs
  properties String? // JSON array of property IDs or data
  news       String? // JSON array of news IDs
  agentInfo  String? // JSON with agent information
  template   String   @default("default")
  status     String   @default("DRAFT") // DRAFT, PUBLISHED, SENT
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  userId     String
  user       User     @relation(fields: [userId], references: [id])

  @@map("newsletters")
}

model SalesFunnel {
  id         String   @id @default(uuid())
  userId     String   @unique
  data       String // JSON array with funnel stages data
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id])

  @@map("sales_funnels")
}
